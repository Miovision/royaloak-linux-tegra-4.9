/*
 * tegra186-p3636-0001-p3509-royaloak-nautilus.dts : Miovision Nautilus Board
 *
 * Copyright (c) 2020, NVIDIA CORPORATION. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; version 2 of the License.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
#include "common/tegra186-p3636-0001-common.dtsi"
#include "common/tegra186-p3509-0000-cvb.dtsi"
#include "common/tegra186-p3509-0000-a00-fixed-regulator.dtsi"
#include "common/tegra186-p3636-0001-a00-prod.dtsi"
#include "common/tegra186-camera-lanai-rbpcv2-imx219.dtsi"

/* plugin manager */
#include "common/tegra186-super-module-e2614-p3509-0000-a00.dtsi"

#include "tegra18x-nautilus_tx2-nx-gpio-default.dtsi"
#include "tegra18x-nautilus_tx2-nx-padvoltage-default.dtsi"
#include "tegra18x-nautilus_tx2-nx-pinmux.dtsi"

/ {
	model = "Miovision Royal Oak Nautilus"
	compatible = "nvidia,p3509-0000+p3636-0001", "nvidia,tegra186";

	nvidia,dtsfilename = __FILE__;
	nvidia,boardids = "3636:0001:A0";
	nvidia,proc-boardid = "3636:0001:A0";
	nvidia,fastboot-usb-vid = <0x0955>;
	nvidia,fastboot-usb-pid = <0xee16>;

	chosen {
		board-has-eeprom;
		bootargs ="console=ttyS0,115200";
		stdout-path = &uarta;
		nvidia,tegra-joint_xpu_rail;
	};

	memory@80000000 {
		device_type = "memory";
		reg = <0x0 0x80000000 0x0 0x70000000>;
	};

	xudc@3550000 {
		status = "okay";
		phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>;
		phy-names = "usb2";
		nvidia,boost-cpu-freq = <1200>;
	};

	usb_cd {
		status = "disabled";
		phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>;
		phy-names = "otg-phy";
		nvidia,xusb-padctl = <&xusb_padctl>;
	};

	xhci@3530000 {
		status = "okay";
		phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>,
			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-1}>,
			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>,
			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-1}>;
		phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-1";
	};

	xusb_padctl@3520000 {
		status = "okay";

		pads {
			usb2 {
				lanes {
					usb2-0 {
						nvidia,function = "xusb";
						status = "okay";
					};
					usb2-1 {
						nvidia,function = "xusb";
						status = "okay";
					};
					usb2-2 {
						nvidia,function = "xusb";
						status = "okay";
					};
				};
			};
			usb3 {
				lanes {
					usb3-1 {
						nvidia,function = "xusb";
						status = "okay";
					};
				};
			};
		};

		ports {
			usb2-0 {
				status = "okay";
				mode = "otg";
			};
			usb2-1 {
				status = "okay";
				mode = "host";
			};
			usb2-2 {
				status = "okay";
				mode = "host";
			};
			usb3-1 {
				nvidia,usb2-companion = <1>;
				status = "okay";
			};
		};
	};

	pcie-controller@10003000 {
		status = "okay";
		pci@1,0 {
			nvidia,num-lanes = <2>;
			nvidia,disable-clock-request;
			status = "okay";
		};
		pci@2,0 {
			nvidia,num-lanes = <1>;
			nvidia,disable-clock-request;
			status = "disabled";
		};
		pci@3,0 {
			nvidia,num-lanes = <1>;
			nvidia,disable-clock-request;
			status = "okay";
		};
	};

	gpio@2200000 {
		w-disable1 {
			gpio-hog;
			output-high;
			gpios = <TEGRA_MAIN_GPIO(L, 0) GPIO_ACTIVE_LOW>;
			label = "w-disable1";
			status = "okay";
		};
		w-disable2 {
			gpio-hog;
			output-high;
			gpios = <TEGRA_MAIN_GPIO(L, 2) GPIO_ACTIVE_LOW>;
			label = "w-disable2";
			status = "okay";
		};
	};

	mttcan@c310000 {
		status = "okay";
	};

	cpufreq@e070000 {
		cpu_emc_map =
			< 499200  204000>,
			< 652800  408000>,
			<1420800  665600>,
			<1920000 1866000>;
	};

	tegra_udrm: tegra_udrm {
		compatible = "nvidia,tegra-udrm";
	};

	host1x {
		nvdisplay@15200000 {
			status = "okay";
			nvidia,dc-or-node = "/host1x/sor1";
			nvidia,dc-connector = <&sor1>;
			nvidia,fb-win = <0>;
			win-mask = <0x7>;
		};
		nvdisplay@15210000 {
			status = "okay";
			bootloader-status = "disabled";
			nvidia,dc-or-node = "/host1x/sor";
			nvidia,dc-connector = <&sor0>;
			nvidia,fb-win = <3>;
			win-mask = <0x38>;
		};
		sor {
			status = "okay";
			nvidia,active-panel = <&sor0_dp_display>;
			dp-display {
				status = "okay";
			};
		};
		sor1 {
			status = "okay";
			nvidia,active-panel = <&sor1_hdmi_display>;
			hdmi-display {
				status = "okay";
			};
		};
		dpaux@155c0000 {
			status = "okay";
		};
		dpaux@15040000 {
			status = "okay";
		};
	};

	// TX2 NX Module SPI 0 --> Tegra SPI 1 (TPM)
	//spi@70000ad4 { // MH: I don't think this is the address, but it might be.
	spi@3210000 {
		status = "okay";
		// Not actually 100% sure this does anything, it was suggested on the NVidia forums. The kernel doesn't
		// look for this, but possibly one of the boot loaders does. This is suppose to disable power management
		// on the interface.
		nvidia,disable-runtime-pm;

		// The PINMUX needed to be adjusted to put the CS line as a GPIO pin which is software controlled,
		// the hardware control was dropping the CS line between transactions resetting the TPM.
		cs-gpios = <&gpio TEGRA_GPIO(C, 3) GPIO_ACTIVE_HIGH>;

		spi@0 {
			reg = <0x0>;
			compatible = "tcg,tpm_tis-spi";
			spi-max-frequency = <10000000>;
			controller-data {
				// This setting along with the cs-gpios keeps the CS active during the full transaction.
				nvidia,clk-delay-between-packets = <0x1>;
			};
		};
	};


	// TX2 NX Module I2C-1 --> X2 I2C2
	// U24 -> 0x70 -> 1V2 vs 1V2_CAM
	// U39 -> 0x71 -> 1V8 vs 1V8_CAM
	// U40 -> 0x72 -> 3V3 vs 3V3_CAM
	// U41 -> 0x73 -> 12V vs 12V_CAM
	// U45 -> 0x74 -> 5V vs 5V_NX
	// U15 -> 0x77 -> 3V3 vs 3V3_SD
	// U46 -> 0x78 -> 3V3 vs 3V3_CELL_UNFLT
	// U47 -> 0x7c -> 3V3 vs 3V3_WIFI_UNFLT
	// U42 -> 0x7f -> 36Vin vs 36Vin_LCD
	// U6  -> 0x48 -> Ambient Temperature
	// U2  -> 0x20 -> Board Id / Rev
	i2c@c240000 {
		status = "okay";
		max9611@70 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x70>;
		};
		max9611@71 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x71>;
		};
		max9611@72 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x72>;
		};
		max9611@73 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x73>;
		};
		max9611@74 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x74>;
		};
		max9611@77 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x77>;
		};
		max9611@78 {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x78>;
		};
		max9611@7c {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x7c>;
		};
		max9611@7f {
			status = "okay";
			compatible = "maxim,max9611";
			reg = <0x7f>;
		};
		lm75@48 {
			status= "okay";
			compatible = "national,lm75";
			reg = <0x48>;
		};
		tca6408@20 {
			status= "okay";
			compatible = "ti,tca6408";
			reg = <0x48>;
		}
	};
	i2c@c250000 {
		status = "okay";
	};
};
#if LINUX_VERSION >= 414
#include <tegra186-linux-4.14.dtsi>
#endif
